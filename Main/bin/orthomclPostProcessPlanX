#!/usr/bin/perl

use strict;

my ($outputDir, $planLetter, $refProteinsFile, $refGroupsFile, $newGroupsFile, $repProteinsFile, $singleCladeProteinsFile) = @ARGV;

usage() unless scalar(@ARGV) >= 5;

die "dir $outputDir does not exist" unless -d $outputDir;
die "file $refProteinsFile does not exist" unless -e $refProteinsFile;
die "file $refGroupsFile does not exist" unless -e $refGroupsFile;
die "file $newGroupsFile does not exist" unless -e $newGroupsFile;
die "file $repProteinsFile does not exist" unless -e "$repProteinsFile";
die "plan letter '$planLetter' must be A or B" unless $planLetter eq 'A' || $planLetter eq 'B';

my $refDir = "$outputDir/ref";
my $newDir = "$outputDir/new";
my $compareDir = $outputDir;

mkdir($refDir);
mkdir($newDir);

my $cmdCount = 0;

stage1($newDir, $newGroupsFile, $refProteinsFile, $singleCladeProteinsFile);
stage1($refDir, $refGroupsFile, $refProteinsFile);

stage2($newDir, $refDir);
stage2($refDir, $newDir);

stage3($newDir, $refDir);
stage3($refDir, $newDir);

# find protein connectivity score deltas (new minus ref)
runCmd("orthomclMakeScoresFile $newDir/proteins_conn_scores $refDir/proteins_conn_scores  > $compareDir/protein_conn_scores_delta");

# load PlanX proteins table
runCmd("orthomclLoadProteinScores $newGroupsFile $compareDir/protein_conn_scores_delta $repProteinsFile $planLetter");

# load PlanX groups table
runCmd("orthomclLoadChangedGroups  $newDir/group_conn_scores $planLetter");



sub stage1 {
  my ($dir, $groupsFile, $proteinIDsFile, $singleCladeProteinsFile) = @_;

  # remove singleton groups
  &runCmd("cat $groupsFile | perl -e 'while(<>) { \@a = split; print if scalar(\@a) > 2;}' > $dir/groups_no_singletons");

  # make group_proteins_sorted (protein IDs found in groups, sorted)
  &runCmd("orthomclExtractProteinIdsFromGroupsFile $dir/groups_no_singletons | sort > $dir/group_proteins_sorted");

  # us it to find singletons, sort them
  &runCmd("diff $proteinIDsFile $dir/group_proteins_sorted | grep \\<| cut -d \" \" -f2|sort > $dir/singletons_sorted");

  # sort groups file (for comparison with other groups file)
  &runCmd("orthomclSortGroupsFile $dir/groups_no_singletons | sort > $dir/groups_sorted");

  # make groups file including only single-clade proteins
  &runCmd("orthomclFilterGroupProteins $dir/groups_sorted $singleCladeProteinsFile > $dir/groups_singleclade_only") if $singleCladeProteinsFile;

  # sort secondary only groups file
  &runCmd("orthomclSortGroupsFile $dir/groups_singleclade_only | sort > $dir/groups_singleclade_sorted") if $singleCladeProteinsFile;

}

sub stage2 {
  my ($dir, $otherDir, $singleCladeProteinsFile) = @_;

  # find non-identical groups
  runCmd("orthomclRemoveIdenticalGroups $dir/groups_sorted $otherDir/groups_sorted > $dir/different_groups");

  # find non-identical secondary groups
  if ($singleCladeProteinsFile) {
    runCmd("orthomclRemoveIdenticalGroups $dir/groups_singleclade_sorted $otherDir/groups_singleclade_sorted > $dir/different_singleclade_groups");
  }

  # find pairs in non-identical groups
  &runCmd("orthomclExtractProteinPairsFromGroupsFile $dir/different_groups | sort > $dir/pairs_sorted");

  # find different singletons (singletons here but not in other)
  runCmd("diff $dir/singletons_sorted $otherDir/singletons_sorted | grep \\>| cut -d \" \" -f2|m > $dir/different_singletons");

  # find protein and group connectivity scores
  &runCmd("orthomclAssessGroups different_groups $dir/different_singletons $dir/groups_conn_scores $dir/proteins_conn_scores");

}

sub stage3 {
  my ($dir, $otherDir) = @_;

  # find missing pairs (pairs in other but not found here)
  runCmd("diff $dir/pairs_sorted $otherDir/pairs_sorted | grep \\> | cut -d \" \" -f2,3 > $dir/missing_pairs");

}

sub runCmd {
  my ($cmd) = @_;
  $cmdCount++;
  print STDERR "\n$cmdCount running: $cmd\n";
  system($cmd) && die "failed";
}

sub usage {
  die "
usage: orthomclPostProcessPlanX outputDir planLetter refProteinsFile refGroupsFile newGroupsFile [repProteinsFile singleCladeProteinsFile]
";
}
