#!/usr/bin/perl

use strict;
use DBI;

my $configFile = $ARGV[0];

&usage() unless $configFile;

my $config = parseConfigFile($configFile);

if (getConfig("dbVendor") eq 'oracle') {
  require DBD::Oracle;
} else {
  require DBD::mysql;
}

my $dbh = DBI->connect(getConfig("dbConnectString"), getConfig("dbLogin"),
		       getConfig("dbPassword")) or die DBI::errstr;

my $orthologTable = getConfig("orthologTable");
my $inParalogTable = getConfig("inParalogTable");
my $coOrthologTable = getConfig("coOrthologTable");

my $dir = "pregroupingReciprocalRelationships";

die "dir '$dir' already exists" if -e $dir;

mkdir($dir);

printOrthologsFile($dbh, $orthologTable, "$dir/orthologs.txt");

printInparalogsFile($dbh, $inParalogTable, "$dir/inparalogs.txt");

printOrthologsFile($dbh, $coOrthologTable, "$dir/coorthologs.txt");

printMclAbcFile($dbh, $orthologTable, $inParalogTable, $coOrthologTable,
	       "orthomclMclInputFile");


################# subroutines #########################

sub printInparalogsFile {
  my ($dbh, $inparalogTable, $fileName) = @_;

  my $sql = "
select taxon_id, sequence_id_a, sequence_id_b, normalized_score
from $inparalogTable
where sequence_id_a < sequence_id_b";

  my $stmt = $dbh->prepare($sql) or die DBI::errstr;
  $stmt->execute();
  open(F, ">$fileName") || die "Can't open '$fileName' for writing";
  while (my ($taxonId, $sourceIdA, $sourceIdB, $score) = $stmt->fetchrow_array()) {
    $score = int($score * 1000 + .5)/1000;
    print F "$taxonId|$sourceIdA\t$taxonId|$sourceIdB\t$score\n";
  }
  close(F);
}

sub printOrthologsFile {
  my ($dbh, $table, $fileName) = @_;

  my $sql = "
select taxon_id_a, sequence_id_a, taxon_id_b, sequence_id_b, normalized_score
from $table
where taxon_id_a || '|' || sequence_id_a < taxon_id_b || '|' || sequence_id_b";

  my $stmt = $dbh->prepare($sql) or die DBI::errstr;
  $stmt->execute();
  open(F, ">$fileName") || die "Can't open '$fileName' for writing";
  while (my ($taxonIdA, $sourceIdA, $taxonIdB, $sourceIdB, $score) = $stmt->fetchrow_array()) {
    $score = int($score * 1000 + .5)/1000;
    print F "$taxonIdA|$sourceIdA\t$taxonIdB|$sourceIdB\t$score\n";
  }
  close(F);
}

sub printMclAbcFile {
  my ($dbh, $orthologTable, $inParalogTable, $coOrthologTable, $fileName) = @_;

  my $sql = "
  select sequence_id_a, sequence_id_b, normalized_score
  from $inParalogTable
  union
  select sequence_id_a, sequence_id_b, normalized_score
  from $orthologTable
  union
  select sequence_id_a, sequence_id_b, normalized_score
  from $coOrthologTable
";

  my $stmt = $dbh->prepare($sql) or die DBI::errstr;
  $stmt->execute() or die DBI::errstr;
  open(F, ">$fileName") || die "Can't open '$fileName' for writing";
  while (my ($queryId, $subjectId, $score) = $stmt->fetchrow_array()) {
    $score = int($score * 1000 + .5)/1000;
    print F "$queryId\t$subjectId\t$score\n";
  }
  close(F);
}

sub getConfig {
  my ($prop) = @_;
  die "can't find property $prop in config file" unless $config->{$prop};
  return $config->{$prop};
}

sub usage {
  print "
Dump files from the database produced by the orthomclEdges program.

usage: orthomclEdgesDumpFiles config_file

where:
  config_file : see below (you can use the same file given to orthomclEdges)

Database Input:
  - InParalog, Ortholog, CoOrtholog tables - populated by orthomclEdges

Output files:
  orthomclMclInput                       - file required by the mcl program
  pregroupingReciprocalRelationships/    - dir holding relationship files
    orthologs.txt                        - ortholog relationships
    inparalogs.txt                       - inparalog relationships
    coorthologs.txt                      - coortholog relationships

The pregrouping relationship files contain the same information as the
orthomclMclInput file, but segragated by relationship type.  These are
candidate relationships (edges) that will subsequently be grouped (clustered)
by the mcl program to form the OrthoMCL ortholog groups.  These files contain
more sensitive and less selective relationships then the final ortholog groups.

Standard Error:
  - logging info

Sample Config File:

dbVendor=oracle  (or mysql)
dbConnectString=dbi:Oracle:orthomcl
dbLogin=my_db_login
dbPassword=my_db_password
orthologTable=Ortholog
inParalogTable=InParalog
coOrthologTable=CoOrtholog
";
  exit(1);
}

