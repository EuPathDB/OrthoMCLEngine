#!/usr/bin/perl

use DBI;
use FindBin;
use lib "$FindBin::Bin/../lib/perl";
use OrthoMCLEngine::Main::Base;
use strict;

usage() unless (@ARGV >= 2);
my $configFile = $ARGV[0];
my $blastFile = $ARGV[1];
my $sqlLog = $ARGV[2];

my $base = OrthoMCLEngine::Main::Base->new($configFile);
my $dbh = $base->getDbh();

if ($sqlLog) {
  open (LOGFILE, ">$sqlLog");
}

my $dbVendor = getConfig("dbVendor");

if ($dbVendor eq 'mysql') {
  loadBlastMySQL($blastFile);
}
elsif ($dbVendor eq 'oracle') {
  loadBlastOracle($blastFile);
} else {
  die "Config file '$configFile' contains invalid value '$dbVendor' for dbVendor\n";
}

sub loadBlastMySQL {
  my ($base, $blastFile) = @_;
  require DBD::mysql;
  my $dbh = $base->getDbh();
  my $sst = $base->getConfig("similarSequencesTable");
  my $sql = "
 LOAD DATA
 LOCAL INFILE \"$blastFile\"
 REPLACE INTO TABLE $sst
 FIELDS TERMINATED BY '\\t'
";
  runSql($dbh, $sql);
}


sub loadBlastOracle {
  my ($base, $blastFile) = @_;

  my $dbLogin = $base->getConfig("dbLogin");
  my $dbPassword = $base->getConfig("dbPassword");
  my $dbString = $base->getConfig("dbConnectString");
  my @database = split(/:/, $dbString);
  my $dbInstance = $database[2];

  open (PARFILE, ">orthomclPar.tmp");
  print PARFILE "userid=$dbLogin/$dbPassword\@$dbInstance\n";
  close PARFILE;

  my $sst = $base->getConfig("similarSequencesTable");

  my $sqlHeader = "
LOAD DATA
INFILE *
INTO TABLE $sst
FIELDS TERMINATED BY \"\\t \" OPTIONALLY ENCLOSED BY '\"'
TRAILING NULLCOLS
(  query_id,
    subject_id,
    query_taxon_id,
    subject_taxon_id,
    evalue_mant,
    evalue_exp,
    percent_identity,
    percent_match
)
BEGINDATA
";

  open (CTLFILE, ">orthomclCtl.tmp");
  print CTLFILE $sqlHeader;
#  print CTLFILE $blastResults;
  close CTLFILE;

  my $command=`sqlldr parfile=orthomclPar.tmp control=orthmclCtl.tmp`;
}

sub runSql {
  my ($dbh, $sql) = @_;

  print LOGFILE "\n$sql" if ($sqlLog);
  my $stmt = $dbh->prepare($sql) or die DBI::errstr;
  $stmt->execute() or die DBI::errstr;
}

sub usage {
 print "
Load Blast results into an Oracle or Mysql database.

usage: orthomclLoadBlast config_file blast_file

where:
  config_file : see below
  blast_file : blast output from orthoclParseBlast 

EXAMPLE: ./orthomclLoadBlast orthoConfig.txt blast_results_file.txt

NOTE: the database login in the config file must have update/insert/truncate privileges on the tables specified in the config file.

Sample Config File:

dbVendor=oracle  (or mysql)
dbConnectString=dbi:Oracle:orthomcl
dbLogin=my_db_login
dbPassword=my_db_password
similarSequencesTable=SimilarSequences
";
}


