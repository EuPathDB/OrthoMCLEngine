#!/usr/bin/perl

use strict;
use DBI;

my $dbLogin = getConfig("dbLogin");
my $dbPassword = getConfig("dbPassword");

my $configFile = $ARGV[0];
usage() unless $configFile;
my $config = parseConfigFile($configFile);

my $blastFile = $ARGV[1];

my $sqlLog = $ARGV[2];
 if ($sqlLog) {
 open (LOGFILE, ">$sqlLog");
 }

my $mysqlDatabase = getConfig("mysqlDatabase");
my $sst = getConfig("similarSequencesTable");

my $sqlHeader = "
LOAD DATA
INFILE *
INTO TABLE $dbLogin.$sst
FIELDS TERMINATED BY \"\\t \" OPTIONALLY ENCLOSED BY '\"'
TRAILING NULLCOLS
(  query_id,
    subject_id,
    query_taxon_id,
    subject_taxon_id,
    evalue_mant,
    evalue_exp,
    percent_identity,
    percent_match
)
";

my $blastResults = do { local( @ARGV, $/ ) = $blastFile ; <> } ;
open(BLASTFILE, ">$blastFile");
print BLASTFILE $sqlHeader;
print BLASTFILE $blastResults;

if (getConfig("dbVendor") eq 'oracle') {
  require DBD::Oracle;
}
 else {
  require DBD::mysql;
}

my $dbh = DBI->connect(getConfig("dbConnectString"), getConfig("dbLogin"),
                       getConfig("dbPassword")) or die DBI::errstr;

my $dbVendor = getConfig("dbVendor");

if ($dbVendor eq 'mysql') {
    mysqlDbSelect();
    loadBlastDataMySQL($blastFile);
}
   elsif ($dbVendor eq 'oracle') {
       loadBlastDataOracle($blastFile);
   }


sub loadBlastDataMySQL {
 my $sql = "
 LOAD DATA
 LOCAL INFILE \"$blastFile\"
 REPLACE INTO TABLE $mysqlDatabase.$sst
 FIELDS TERMINATED BY '\\t'
";
  runSql($sql);
}


sub loadBlastDataOracle {
 my $sql = "
HOST sqlldr $dbLogin//$dbPassword control=$blastFile
";
  run($sql);
}


sub parseConfigFile {
  my ($configFile) = @_;

  open(F, $configFile) || die "Can't open config file '$configFile'\n";

  my $config;
  while(<F>) {
    chomp;
    s/\s+$//;
    next if /^\#/;
    /^(\w+)\=(.+)/ || die "illegal line in config file '$_'\n";
    my $key=$1;
    my $val=$2;
    $config->{$key} = $val;
    $val = '********' if $key eq 'dbPassword';
    print STDERR localtime() . " configuration: $key=$val\n";
  }
  return $config;
}


sub getConfig {
  my ($prop) = @_;
  die "can't find property $prop in config file" unless $config->{$prop};
  return $config->{$prop};
}

sub mysqlDbSelect {
 my $sql = "
USE $mysqlDatabase
";
  runSql($sql);
}


sub runSql {
 my $sql = $_[0];
 if ($sqlLog) {
     logSql($sql);
    }
  my $stmt = $dbh->prepare($sql) or die DBI::errstr;
      $stmt->execute() or die DBI::errstr;
}

sub logSql {
  my $sql = $_[0];
  print LOGFILE "\n$sql";
}


sub usage {
 print "
Load Blast results into an Oracle or Mysql database.

usage: orthomclBulkLoad config_file blast_file

where:
  config_file : see below
  blast_file : blast output from orthoclParseBlast 

EXAMPLE: ./orthomclLoadBlast orthoConfig.txt blast_results_file.txt

NOTE: the database login in the config file must have update/insert/truncate privileges on the tables specified in the config file.

Sample Config File:

dbVendor=oracle  (or mysql)
dbConnectString=dbi:Oracle:orthomcl
dbLogin=my_db_login
dbPassword=my_db_password
mysqlDatabase=my_mysql_database
similarSequencesTable=SimilarSequences
orthologTable=Ortholog
inParalogTable=InParalog
coOrthologTable=CoOrtholog
interTaxonMatchView=InterTaxonMatch
percentMatchCutoff=50
evalueExponentCutoff=-5
";
}
if ($sqlLog) {
close LOGFILE;
}
close BLASTFILE;


