#!/usr/bin/perl

use DBI;
use strict;

usage() unless scalar(@ARGV) == 4;

my $newGroupsFile = $ARGV[0];
my $proteinScoresFile = $ARGV[1];
my $repProteinIDsFile = $ARGV[2];
my $synScoresFile = $ARGV[3];
my $planLetter = $ARGV[4];

die "plan_letter arg '$planLetter' must be A or B" unless $planLetter eq 'A' || $planLetter eq 'B';

open(N, $newGroupsFile) || die "Could not open file '$newGroupsFile'\n";
my %proteinNewGroup;

while(<N>) {
  chomp;
  my @a = split;
  my $id = shift @a;
  $id =~ s/\://;
  map { $proteinNewGroup{$_} = $id} @a;
}
close(N);

my %repProteins;
open(R, $repProteinIDsFile) || die "can't open file '$repProteinIDsFile'\n";
while(<R>) {
    chomp;
    $repProteins{$_} = 1;
}

open(F, $proteinScoresFile) || die "can't open file $proteinScoresFile\n";
my %proteinConnScores;
while(<F>) {
    chomp;
    my @a = split;
    my $id = shift @a;
    $proteinConnScores{$id} = \@a;
}
close(F);

my $dbh = DBI->connect("dbi:Oracle:orth500n", "sfischer", "",
		    {PrintError => 0, RaiseError => 1}) or die DBI::errstr;

my $sql = "
insert into apidb.ProteinToPlan${planLetter}GroupId (protein_id, plan_${planLetter}_group_id, score, avg_score, syn_score, is_rep)
values (?, ?, ?, ?, ?, ?)
";


my $stmt = $dbh->prepare("truncate table apidb.ProteinToPlan${planLetter}GroupId");
$stmt->execute();

$stmt = $dbh->prepare($sql);
open(S, $synScoresFile) || die "can't open file '$synScoresFile'\n";
while(<S>) {
    chomp;
    my @a = split;
    my ($id, $syn_score) = @a;
    my ($summed_conn_score, $avg_conn_score) = @{$proteinConnScores{$id}};
    my $isRep = 0;
    $isRep = 1 if $repProteins{$id};
    $stmt->execute($id, $proteinNewGroup{$id}, $summed_conn_score, $avg_conn_score, $synScore, $isRep);
}

sub usage {
die "
 usage: orthomclLoadProteinScores new_groups_file scores_file
";
}

