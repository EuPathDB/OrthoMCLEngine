#!/usr/bin/perl

use strict;

usage() unless (@ARGV >= 1);
my $configFile = $ARGV[0];
my $sqlLog = $ARGV[1];

my $base = OrthomclEngine::Main::Base->new($configFile);
my $dbh = $base->getDbh();

if ($sqlLog) {
  open (LOGFILE, ">$sqlLog");
}

my $intType = ($dbVendor eq 'oracle') ? 'NUMBER' : 'INT';

createSimilarSequencesTable();
createInParalogTable();
createOrthologTable();
createCoOrthologTable();
createInterTaxonMatchView();

##############################################################

sub createSimilarSequencesTable {
  my $sst = getConfig("similarSequencesTable");
  my $oracleNoLogging = $base->getConfig("dbVendor") eq 'oracle'? " NOLOGGING" : "";

  my $sql = "
CREATE TABLE $sst $oracleNoLogging (
 QUERY_ID                 $intType,
 SUBJECT_ID               $intType,
 QUERY_TAXON_ID           $intType,
 SUBJECT_TAXON_ID         $intType,
 EVALUE_MANT              $intType,
 EVALUE_EXP               FLOAT,
 PERCENT_IDENTITY         FLOAT,
 PERCENT_MATCH            FLOAT
)
";
  runSql($sql);

  $sql = "
CREATE INDEX ss_qtaxexp_ix
ON $sst(query_id, subject_taxon_id,
evalue_exp, evalue_mant,
query_taxon_id, subject_id)
";
  runSql($sql);

  $sql = "
CREATE INDEX ss_seqs_ix 
ON $sst(query_id, subject_id,
evalue_exp, evalue_mant)
";
  runSql($sql);
}


sub createInParalogTable {
 my $ipt = getConfig("inParalogTable");
 my $sql = "
CREATE TABLE $ipt (
 SEQUENCE_ID_A           $intType,
 SEQUENCE_ID_B           $intType,
 TAXON_ID                $intType,
 UNNORMALIZED_SCORE      FLOAT,
 NORMALIZED_SCORE        FLOAT
)
";
  runSql($sql);
}


sub createOrthologTable  {
 my $olt = getConfig("orthologTable");
 my $sql = " 
CREATE TABLE $olt  (
 SEQUENCE_ID_A           $intType,
 SEQUENCE_ID_B           $intType,
 TAXON_ID_A              $intType,
 TAXON_ID_B              $intType,
 UNNORMALIZED_SCORE      FLOAT,
 NORMALIZED_SCORE        FLOAT
)
";
  runSql($sql);

$sql = "
CREATE INDEX ortholog_seq_a_ix ON $olt(sequence_id_a)
";
  runSql($sql);

$sql = "
CREATE INDEX ortholog_seq_b_ix ON $olt(sequence_id_b)
";
  runSql($sql);
}


sub createCoOrthologTable  {
 my $cot = getConfig("coOrthologTable");
 my $sql = "
CREATE TABLE $cot (
 SEQUENCE_ID_A           $intType,
 SEQUENCE_ID_B           $intType,
 TAXON_ID_A              $intType,
 TAXON_ID_B              $intType,
 UNNORMALIZED_SCORE      FLOAT,
 NORMALIZED_SCORE        FLOAT
)
";
  runSql($sql);
}

sub createInterTaxonMatchView {
 my $itv = getConfig("interTaxonMatchView");
 my $sql = "
CREATE OR REPLACE VIEW $itv 
	AS SELECT ss.query_id, ss.subject_id, ss.subject_taxon_id, 
	ss.evalue_mant, ss.evalue_exp 
	FROM SimilarSequences ss 
	WHERE ss.subject_taxon_id != ss.query_taxon_id
";
 runSql($sql);
}

sub runSql {
 my $sql = $_[0];
 if ($sqlLog) {
     logSql($sql);
    }
  my $stmt = $dbh->prepare($sql) or die DBI::errstr;
      $stmt->execute() or die DBI::errstr;
}


sub logSql {
  my $sql = $_[0];
  print LOGFILE "\n$sql";
}

sub usage {
 print "
Create OrthoMCL schema in an Oracle or Mysql database.

usage: orthomclInstallSchema config_file sql_log_file

where:
  config_file : see below
  sql_log_file : optional dump of sql from script

EXAMPLE: ./orthomclInstallSchema orthoConfig.txt sqlLog.txt

NOTE: the database login in the config file must have update/insert/truncate privileges on the tables specified in the config file.

Sample Config File:

dbVendor=oracle  (or mysql)
dbConnectString=dbi:Oracle:orthomcl
dbLogin=my_db_login
dbPassword=my_db_password
blastResultsTable=BlastResults
orthologTable=Ortholog
inParalogTable=InParalog
coOrthologTable=CoOrtholog
interTaxonMatchView=InterTaxonMatch

";
}

